# =============================================================================
# MAESTROVERSE ENVIRONMENT CONFIGURATION
# =============================================================================
# Copy this file to .env and update with your actual values
# NEVER commit the .env file to version control

# =============================================================================
# SERVER CONFIGURATION
# =============================================================================
NODE_ENV=development
PORT=3001

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================
# PostgreSQL connection string
# Format: postgresql://USER:PASSWORD@HOST:PORT/DATABASE
DATABASE_URL=postgresql://maestro:maestro123@postgres:5432/maestroverse

# For local development (without Docker):
# DATABASE_URL=postgresql://maestro:maestro123@localhost:5432/maestroverse

# =============================================================================
# JWT & AUTHENTICATION CONFIGURATION
# =============================================================================
# REQUIRED: Strong secret key for JWT signing (generate with: openssl rand -base64 64)
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# JWT Configuration (DO NOT CHANGE - enforced by token utilities)
# Access tokens: 15 minutes (hardcoded in src/utils/tokens.js)
# Refresh tokens: 7 days (hardcoded in src/utils/tokens.js)

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================
# Root admin email addresses (comma-separated, auto-promoted to ADMIN role on login)
ROOT_ADMIN_EMAILS=admin@maestro.edu

# -----------------------------------------------------------------------------
# CORS CONFIGURATION (Cross-Origin Resource Sharing)
# -----------------------------------------------------------------------------
# REQUIRED IN PRODUCTION: Comma-separated list of allowed origins
# CRITICAL: Server will FAIL TO START in production if not configured
#
# Development Examples:
CORS_ORIGINS=http://localhost:3005,http://localhost:3000
#
# Production Examples (HTTPS required):
# CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com,https://api.yourdomain.com
# CORS_ORIGINS=https://maestroverse.edu,https://www.maestroverse.edu
#
# IMPORTANT:
# - Origins must include protocol (http:// or https://)
# - Origins must include port if non-standard (e.g., http://localhost:3005)
# - Wildcard (*) is PROHIBITED in production for security
# - Credentials are only allowed for whitelisted origins
# - Unknown origins are BLOCKED automatically
# - Startup validation ensures production safety
#
# Security Features:
# ✓ Strict origin validation (no wildcards in production)
# ✓ Credential blocking for non-whitelisted origins
# ✓ Startup assertion that fails boot if misconfigured
# ✓ Case-sensitive origin matching
# ✓ No subdomain wildcards allowed

# Cookie configuration (automatically set based on NODE_ENV)
# - Production: secure=true (HTTPS only), sameSite=strict
# - Development: secure=false, sameSite=lax

# =============================================================================
# OAUTH2 CONFIGURATION (Google & GitHub)
# =============================================================================
# Frontend URL for OAuth redirects
FRONTEND_URL=http://localhost:3005

# Google OAuth Configuration
# Get credentials from: https://console.cloud.google.com/apis/credentials
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_CALLBACK_URL=http://localhost:3001/api/auth/google/callback

# GitHub OAuth Configuration
# Get credentials from: https://github.com/settings/developers
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
GITHUB_CALLBACK_URL=http://localhost:3001/api/auth/github/callback

# =============================================================================
# REDIS CONFIGURATION (Optional - for caching)
# =============================================================================
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=

# For local development (without Docker):
# REDIS_HOST=localhost

# =============================================================================
# FILE UPLOAD CONFIGURATION (SECURE)
# =============================================================================
# NOTE: File uploads now use secure handling with:
# - MIME-type validation (whitelist)
# - 5MB max file size
# - Path traversal prevention
# - Secure filename generation
# - Private storage with signed URL access
#
# Files are stored in private-uploads/ and served via /api/files/serve/:token
# Signed URLs expire after 1-24 hours depending on use case

# API base URL for signed URL generation
API_URL=http://localhost:3001

# For production, set to your API domain:
# API_URL=https://api.yourdomain.com

# =============================================================================
# EMAIL CONFIGURATION (Optional - for email notifications)
# =============================================================================
# SMTP Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password

# Email sender details
EMAIL_FROM=Maestroverse <noreply@maestro.edu>

# =============================================================================
# RATE LIMITING CONFIGURATION
# =============================================================================
# Layered rate limiting with per-IP and per-identifier (email/username) buckets
# Includes exponential backoff, CAPTCHA thresholds, and account lockout

# Window duration in milliseconds (default: 300000 = 5 minutes)
RATE_LIMIT_WINDOW_MS=300000

# Maximum attempts per window (default: 5)
RATE_LIMIT_MAX_ATTEMPTS=5

# Exponential backoff multiplier (default: 2)
# Formula: backoffDuration = windowMs * (multiplier ^ violationCount)
RATE_LIMIT_BACKOFF_MULTIPLIER=2

# Maximum backoff duration in milliseconds (default: 7200000 = 2 hours)
RATE_LIMIT_MAX_BACKOFF_MS=7200000

# Failures before CAPTCHA required (default: 3)
# After this many failures, response includes requiresCaptcha flag
RATE_LIMIT_CAPTCHA_THRESHOLD=3

# Failures before account lockout (default: 10)
# Account is temporarily locked after exceeding this threshold
RATE_LIMIT_LOCKOUT_THRESHOLD=10

# Account lockout duration in milliseconds (default: 3600000 = 1 hour)
RATE_LIMIT_LOCKOUT_DURATION_MS=3600000

# Global API rate limit - max requests (default: 1000)
GLOBAL_RATE_LIMIT_MAX=1000

# Global API rate limit - window in minutes (default: 15)
GLOBAL_RATE_LIMIT_WINDOW_MIN=15

# Default settings by action:
# - Login: RATE_LIMIT_MAX_ATTEMPTS per RATE_LIMIT_WINDOW_MS (layered: IP + identifier)
# - Register: 3 attempts per 15 minutes (IP-based)
# - API: 100 requests per minute (IP-based)
# - Password Reset: 3 attempts per 15 minutes (IP-based)
# - Email Verification: 5 attempts per 10 minutes (IP-based)

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
# Log level (error, warn, info, debug)
LOG_LEVEL=info

# =============================================================================
# SESSION CONFIGURATION (Optional - for future session-based features)
# =============================================================================
SESSION_SECRET=your-session-secret-change-this

# =============================================================================
# WEBSOCKET CONFIGURATION
# =============================================================================
# WebSocket connection requires JWT authentication
# Token must be passed in socket.handshake.auth.token

# =============================================================================
# PRODUCTION SECURITY CHECKLIST
# =============================================================================
# Before deploying to production, ensure:
# ✓ NODE_ENV=production
# ✓ Strong JWT_SECRET (64+ characters, cryptographically random)
# ✓ Strong SESSION_SECRET (64+ characters, cryptographically random)
# ✓ HTTPS enabled (automatic redirect configured in src/index.js)
# ✓ Secure database password
# ✓ CORS_ORIGINS configured with HTTPS production domains (CRITICAL - server will not start without it)
# ✓ No wildcard (*) in CORS_ORIGINS (prohibited in production)
# ✓ ROOT_ADMIN_EMAILS configured with trusted admin emails
# ✓ Email SMTP configured for notifications
# ✓ Database backups configured
# ✓ Rate limiting tested and configured appropriately
# ✓ CSRF protection enabled (automatic for cookie-based auth)
# ✓ All .env values reviewed and updated

# =============================================================================
# DOCKER CONFIGURATION
# =============================================================================
# Docker services defined in docker-compose.yml:
# - postgres: PostgreSQL 15 on port 5432
# - redis: Redis 7 on port 6379
# - server: Express API on port 3001
# - web: Next.js frontend on port 3005 (mapped from container port 3000)

# To start all services: npm run dev
# To stop all services: npm run docker:stop
# To view logs: npm run docker:logs
